<a href="https://shift.infinite.red/using-redux-saga-to-simplify-your-growing-react-native-codebase-2b8036f650de">https://shift.infinite.red/using-redux-saga-to-simplify-your-growing-react-native-codebase-2b8036f650de</a><div id="articleHeader"><h1>Using redux-saga To Simplify Your Growing React Native Codebase</h1></div><figure id="de27"><div><div><img src="https://cdn-images-1.medium.com/freeze/max/60/1*3WWtvlQdtsQujZkMkvTTlQ.jpeg?q=20" /><div class="readableLargeImageContainer"><img src="https://cdn-images-1.medium.com/max/1600/1*3WWtvlQdtsQujZkMkvTTlQ.jpeg" /></div></figure><blockquote id="8a4f">Some of the most fragile, embarrassing, and unreadable code you will write is flow control. — Beowulf</blockquote><h3 id="068f">So What’s the Problem Here Anyway?</h3><p id="e38a">Look. You know how it goes.</p><p id="ef52">Just call an API and grab the data. Simple right?</p><figure id="2d35"><div><div><img src="https://cdn-images-1.medium.com/freeze/max/60/1*JhumDuUuqWrqrQdjo3k_JQ.png?q=20" /><img src="https://cdn-images-1.medium.com/max/1600/1*JhumDuUuqWrqrQdjo3k_JQ.png" /></div><figcaption>No worries! Promise!</figcaption></figure><p id="3bbb">Oh, but it might timeout after 30 seconds. So trap for that.</p><p id="685e">And we should also handle server errors because the backend team is using PHP (<em>zing!</em>).</p><p id="d953">Then once we get the data back, let’s hand it off to the Redux reducers. But let’s also update a few cached data points first. And fetch a few images so the UI is a bit snappier once the user starts scrolling.</p><figure id="5355"><div><div><img src="https://cdn-images-1.medium.com/freeze/max/60/1*2kVjfLGnMJq8-mLQ8fLb0Q.png?q=20" /><img src="https://cdn-images-1.medium.com/max/1600/1*2kVjfLGnMJq8-mLQ8fLb0Q.png" /></div><figcaption>I cannot indent any further captain!</figcaption></figure><p id="3efa">But before all that, put up a loading screen. And once we finish, dismiss it. Oh, and update our usage tracking metrics too.</p><figure id="479a"><div><div><img src="https://cdn-images-1.medium.com/freeze/max/60/1*Vd0ml-ZIbdT-nGur_WTY9A.png?q=20" /><img src="https://cdn-images-1.medium.com/max/1600/1*Vd0ml-ZIbdT-nGur_WTY9A.png" /></div><figcaption>Caaaaaaaaaaallbacks!</figcaption></figure><p id="a5db">What a mess.</p><h3 id="d4f9">What Are Sagas?</h3><p id="0116">By giving flow control a safe haven, sagas allow you to remove much clutter and confusion from the rest of your app.</p><p id="ef94">They help organize the chaos of actions & reactions that litter your codebase.</p><p id="b5f9">Whether you use <strong>promises</strong>, <strong>callbacks</strong>, <strong>try</strong>/<strong>catch</strong> blocks, or good ol’ <strong>if</strong> statements, sagas help you turn these stories into instructions.</p><p id="72a7">Testable, mockable, declarative instructions.</p><h3 id="85e5">What’s Wrong With What I’m Doing Already?</h3><p id="3361">If you’re new to sagas (but not Redux), you probably have your action creators doing some of your flow control via <strong>redux-thunk</strong>. It might be hard to test, but you know what? It works.</p><pre id="bac2">// an action creator with thunking<br />function createRequest () {<br />  return function (dispatch, getState) {<br />    dispatch({ type: 'REQUEST_STUFF' })<br />    someApiCall(function(response) {<br />      // some processing<br />      dispatch({ type: 'RECEIVE_STUFF' })<br />    }<br />  }<br />}</pre><p id="7e1a">You probably have other bits located in components.</p><pre id="6128">function onHandlePress () {<br />  this.props.dispatch({ type: 'SHOW_WAITING_MODAL' })<br />  this.props.dispatch(createRequest())<br />}</pre><p id="4fb2">And you’ve used the redux state tree (and reducers) to act as a signalling system to chain stuff together.</p><p id="a174">Code is everywhere.</p><p id="b8e8">Sagas can be a way out of that sprawl so you trigger your flows with one action.</p><pre id="b1be">function onHandlePress () {<br />  this.props.dispatch(createRequest())<br />}</pre><p id="0114">And whatever steps are involved, are centralized within the saga.</p><p id="4f48">Still a bit fuzzy right?</p><h3 id="631d">What Do They Look Like?</h3><p id="23f4">Sagas are implemented as <a href="https://davidwalsh.name/es6-generators" target="_blank"><strong>generator</strong></a> functions. Functions with benefits.</p><pre id="70b7">function *hello() {<br />}</pre><p id="bef9">The <strong>*</strong> is pronounced <strong>superstar</strong>. Fact.</p><p id="a0e9">The series of steps that make up your saga are yielded along the way.</p><pre id="0cec">function *hello() {<br />  yield 'step 1 — cut a hole in a box'<br />  yield 'step 2 ...'<br />}</pre><p id="9ae6">Inside the <strong>redux-saga</strong> toolbox is a few useful things you can yield. Some are generic in nature (<strong>call</strong>), some are Redux-specific (<strong>put</strong> and <strong>take</strong>) and some of them are wacky thread-like things (<strong>fork</strong>, <strong>join</strong>, <strong>cancel</strong>, <strong>race</strong>).</p><p id="db2a">Remember that completely contrived example from earlier? Well, portions of it might look something like this:</p><pre id="9b98">function *hello() {<br />  yield take('BEGIN_REQUEST')<br />  yield put({ type: 'SHOW_WAITING_MODAL' })<br />  const response = yield call(myApiFunctionThatWrapsFetch)<br />  yield put({ type: 'PRELOAD_IMAGES', response.images })<br />  yield put({ type: 'USAGE_TRACK', activity: 'API_CALL'})<br />  yield put({ type: 'HIDE_WAITING_MODAL' })<br />}</pre><p id="2585">Ok, I just ambushed you with a lot there. Yes the <strong>yield</strong> is ugly. Yes, the <strong>*</strong> is weird. Without that odd syntax you’re left with 6 1-liners that do this:</p><ol><li id="04da">Wait for a <strong>BEGIN_REQUEST</strong> action to come through Redux.</li><li id="a15f">Dispatch a <strong>SHOW_WAITING_MODAL</strong> action through Redux.</li><li id="c189">Call the API and get back a response.</li><li id="d8e7">Dispatch an action through Redux for someone to start downloading some images.</li><li id="7c59">Seeing a pattern here?</li><li id="4c9f">Yep, I bet you are.</li></ol><p id="fc7b">Not bad eh?</p><p id="89c2">We’ve just described a nice flow.</p><h3 id="8c17">How Do You Run Them?</h3><p id="680e">Sagas are Redux middleware. When you configure your Redux store, your sagas are injected into the store via the <strong>sagaMiddleware()</strong> function.</p><p id="fb3d">Cool, but that didn’t answer your question did it?</p><p id="0e3f">Let’s go back to our <strong>*hello()</strong> saga for a second. Let’s pretend that we injected that into our store with <strong>sagaMiddleware([hello])</strong>.</p><p id="6ac6">Once the Redux store springs to life, <strong>hello</strong> gets executed.</p><p id="5686">But, do you remember line 1?</p><pre id="81f0">yield take('BEGIN_REQUEST')</pre><p id="e08c">Execution will now stop. And wait. The non-blocking kind. <em>Patiently. Lurking</em>. Until the right message flows through Redux.</p><p id="6bed">And when it does, execution will continue along until the next <strong>yield</strong>. And so-on. When the function is done, the saga is over.</p><p id="c776">You can turn sagas into <strong>daemons</strong> by wrapping them in endless loops.</p><pre id="5bde">function *foreverAlone () {<br />  while (true) {<br />    yield take('HI')<br />    yield put({ type: 'WAVE' })<br />  }<br />}</pre><p id="673e">Sagas accept a parameter too. A <strong>getState</strong> function. That’s one way to get information from your Redux state tree.</p><h3 id="8b0a">How Do You Test Them?</h3><p id="c3e1">Well, turns out, <strong>put</strong>, <strong>call</strong>, <strong>take</strong> and all the other <strong>redux-saga</strong> commands are <em>instructions</em>. They’re functions that return an object.</p><pre id="d38b">{ TAKE: 'HI' }</pre><p id="6f5a">When your saga runs within the Redux <strong>sagaMiddleware</strong>, they perform as you’ve read. But when run in a unit test, they just return instructions. Which you can test!</p><p id="41ef">Here’s an example:</p><pre id="7265">test('foreverAlone', (t) =&gt; {<br />  const saga = foreverAlone()</pre><pre id="82ea">  let actual = null<br />  let expected = null</pre><pre id="3071">  // test step 1<br />  actual = saga.next().value<br />  expected = take('HI')<br />  t.deepEqual(actual, expected, 'waits for hi action')</pre><pre id="6609">  // test step 2<br />  actual = saga.next().value<br />  expected = put({ type: 'WAVE' })<br />  t.deepEqual(actual, expected, 'dispatch a wave action')<br />}</pre><p id="6252">Your generator gets stepped through one <strong>yield</strong> at a time by calling <strong>next()</strong>. <strong>next()</strong> returns an object with a <strong>.value</strong> that shows you what was yielded.</p><p id="db16"><strong>next()</strong> can also accept parameters. This way you can inject mocked data into your generators to test things branching logic paths (like <strong>if</strong> statements and <strong>try/catch </strong>blocks).</p><h3 id="e50e">Epilogue</h3><p id="73b5">For me, settling in on <strong>redux-saga</strong> allowed me to simplify my whole actions layer. Action creators are mostly one-liners now. Pure functions.</p><p id="2345">My flow control layer is now a series of a dozen or so (and counting) sagas (<em>running as daemons</em>) anxiously waiting for their time to shine. They also have test coverage.</p><p id="c26b">When I converted to <strong>redux-saga</strong>, suddenly my:</p><ul><li id="ed18">components became simpler</li><li id="b0f5">action creators pared down to next-to-nothing</li><li id="42f6">reducers didn’t change at all</li><li id="adb6">flow control was now isolated & testable</li></ul><p id="0842">Check out the <a href="https://github.com/yelouafi/redux-saga" target="_blank"><strong>redux-saga library</strong></a> on Github. The <strong>README</strong> is beautiful. It covers much more than I do here.</p><p id="4c10">Thanks to <a href="https://twitter.com/YassineElouafi2" target="_blank"><strong>Yassine Elouafi</strong></a> for creating such a wonderful library. And thanks to <a href="https://twitter.com/dan_abramov" target="_blank"><strong>Dan Abramov</strong></a> for Redux and his <a href="https://twitter.com/dan_abramov/status/677900237281878019" target="_blank"><strong>tweet</strong></a> which introduced me to <strong>redux-saga</strong>.</p><p id="27b9">Be sure to read <a href="http://jaysoo.ca/2016/01/03/managing-processes-in-redux-using-sagas/" target="_blank"><strong>Jack Hsu</strong></a>’s article on Sagas. Also <a href="http://riadbenguella.com/from-actions-creators-to-sagas-redux-upgraded/" target="_blank"><strong>Riad Benguella</strong></a> has a post about this topic as well. Both are great reads.</p><p id="7fc6">Have questions? Comments? I’m <a href="https://twitter.com/skellock" target="_blank"><strong>skellock on Twitter</strong></a>. Or visit us at <a href="http://infinite.red" target="_blank"><strong>Infinite Red</strong></a><strong>.</strong></p>