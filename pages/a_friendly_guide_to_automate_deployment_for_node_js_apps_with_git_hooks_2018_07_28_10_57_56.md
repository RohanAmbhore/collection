<a href="https://medium.com/@aunnnn/automate-digitalocean-deployment-for-node-js-with-git-and-pm2-67a3cfa7a02b">https://medium.com/@aunnnn/automate-digitalocean-deployment-for-node-js-with-git-and-pm2-67a3cfa7a02b</a><div id="articleHeader"><h1>A Friendly Guide To Automate Deployment For Node.js Apps With Git Hooks</h1></div><p id="ea42"><em>Note: This article is just a simpler version of </em><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-automatic-deployment-with-git-with-a-vps" target="_blank"><em>this</em></a><em> and </em><a href="https://www.digitalocean.com/community/tutorials/how-to-use-git-hooks-to-automate-development-and-deployment-tasks" target="_blank"><em>this</em></a><em>.</em></p><p id="2b4a"><em>Note2: You may want to checkout </em><a href="https://blog.cloudboost.io/preparing-ubuntu-16-04-for-node-js-mongodb-applications-b1f7f81f5bf4" target="_blank"><em>prepare your droplet for running Node.js apps</em></a><em> first.</em></p><h3 id="a1d6">Our Goal Here</h3><ol><li id="1c5f">With git, the code on a droplet must be up-to-date with the code on our laptop.</li><li id="39e2">The app restarts automatically after each deploy.</li></ol><h3 id="6933">The Mental Model of This</h3><p id="3fc3">First, you will setup a git repo on a droplet that will reflect your code on your laptop. Imagine something like github repo, a place that you push code to. While the code on github is for sharing, the code on your droplet will actually be running.</p><p id="158c">Second, we can automatically run some scripts after a particular event occurs in a git repo. This is done via <a href="https://www.atlassian.com/git/tutorials/git-hooks" target="_blank">git hooks</a>. As you might imagined, it would do something like <code>npm install</code> and <code>npm start.</code></p><p id="3d29">After these setups, now every time you push your code there, git hooks will done the rest to get your app running.</p><figure id="e8bc"><div><div><img src="https://cdn-images-1.medium.com/freeze/max/60/1*C9T1isZBrFTP37caDq2JCw.png?q=20" /><div class="readableLargeImageContainer"><img src="https://cdn-images-1.medium.com/max/1600/1*C9T1isZBrFTP37caDq2JCw.png" /></div><figcaption>Our deployment process</figcaption></figure><h3 id="8293">Steps</h3><ol><li id="c673">Introducing pm2</li><li id="ad09">Setting up bare repo on your droplet</li><li id="9e4a">Adding remote repo on your working directory</li></ol><h3 id="0c96">1. What’s pm2?</h3><p id="841e"><a href="https://github.com/Unitech/pm2" target="_blank">pm2</a> is a command line to manage and run multiple processes. Normally you’re blocked after you run ‘npm start’. However, pm2 runs apps and leave them alone. It also restarts an app automatically if any app crashes. Plus, you get a beautiful panel to check all apps running with pm2.</p><figure id="9e9f"><div><div><img src="https://cdn-images-1.medium.com/freeze/max/60/1*Vtr3By2aexzWCKlR6coofQ.png?q=20" /><div class="readableLargeImageContainer"><img src="https://cdn-images-1.medium.com/max/1600/1*Vtr3By2aexzWCKlR6coofQ.png" /></div><figcaption>pm ls</figcaption></figure><p id="0bee">To install this on your droplet:</p><pre id="c92e">$ npm install pm2 -g</pre><p id="fcb9">And you can start an app with this command:</p><pre id="dc17">$ pm2 start npm --name ‘aunnnn-by-githook’ — start</pre><h3 id="9be7">2. Setting Up Automate Deployment in 3 Steps</h3><p id="8fbd">Alright here’s the main part. <em>Do these on your droplet.</em></p><ol><li id="caba"><strong>Initialize a git bare repository at </strong><code><strong>/opt</strong></code></li></ol><pre id="4030">$ git init --bare /opt/my-first-app.git</pre><p id="1ec2"><a href="https://stackoverflow.com/a/28428742/6666165" target="_blank"><strong>What’s a bare repo?</strong></a> <em>It’s a repo specifically for pushing your work to, e.g., not for developing on it directly. Perfect for live version.</em></p><p id="28e7"><strong>2. Clone to a directory that will contain all your code</strong></p><pre id="5804">$ git clone /opt/my-first-app.git /opt/live/my-first-app</pre><p id="b664"><strong>3. Add post-receive hook at </strong><code><strong>/opt/my-first-app.git/hooks</strong></code></p><p id="34ce">The file contains commands that you want your droplet to run after the bare repo receives all the code.</p><p id="8994">You’ll see lots of hooks there, but no post-receive yet. You must create one yourself. E.g., <code>nano post-receive</code> and add something like this:</p><pre id="8805">#!/bin/bash</pre><pre id="71a6">echo ‘post-receive: Triggered.’</pre><pre id="d781">cd /opt/live/my-first-app</pre><pre id="aca3">echo ‘post-receive: git check out…’</pre><pre id="993f">git --git-dir=/opt/my-first-app.git --work-tree=/opt/live/my-first-app checkout master -f</pre><pre id="8e4c">echo ‘post-receive: npm install…’</pre><pre id="7e0c">npm install \</pre><pre id="0f03">&& echo ‘post-receive: building…’ \</pre><pre id="b656">&& npm run build \</pre><pre id="faf8">&& echo ‘post-receive: → done.’ \</pre><pre id="0aab">&& (pm2 delete ‘my-first-app-by-githook’ || true) \</pre><pre id="5f00">&& pm2 start npm --name ‘my-first-app-by-githook’ -- start \</pre><pre id="f49c">&& echo ‘post-receive: app started successfully with pm2.</pre><p id="8500">Just edit the above to suit your need. E.g., edit echo, skip <code>npm build</code></p><p id="0666"><em>Note 1: </em><code><em>&&</em></code><em> is to execute commands synchronously.</em></p><p id="5015"><em>Note 2: </em><code><em>\</em></code><em> is to write && in multiple lines. It’s the same as one-liner: </em><code><em>command1 && command2 && command3 && ...</em></code></p><p id="7360"><strong>4. Make post-receive executable</strong></p><pre id="a42b">$ chmod ug+x ./post-receive</pre><h3 id="c3ff">3. Add the remote repo on your laptop</h3><p id="64f7">Last step. <em>Do these on your working directory on your laptop.</em></p><p id="55d6">Now we have to add remote repository at your working directory, so that we can push our code to the bare repo we just set up.</p><ol><li id="2a76"><strong>If you need to check existing remote repo first:</strong></li></ol><pre id="8253">$ git remote -v</pre><p id="51c3"><strong>2. To add a new remote repo:</strong></p><pre id="283c">$ git remote add live ssh://root@123.123.123.123/opt/my-first-app.git</pre><p id="9531"><em>Suppose IP Address of your droplet is 123.123.123.123</em></p><p id="a4a5">Note: you can change <code>live</code> to something else, e.g., <code>prod</code>. It’s just a name of your remote.</p><p id="e9b7">If you have remote repo at github too, you’d see something like this:</p><figure id="3a66"><div><div class="readableLargeImageContainer"><img src="https://cdn-images-1.medium.com/max/1600/1*JR4eDsdlQDErx7SGanqh4Q.png" /></div><figcaption>All remotes</figcaption></figure><h3 id="52f7">Let’s try</h3><p id="7cc1">OK. All are set. Now suppose you edit some code. Committed, and merged it to master.</p><p id="ac60">To deploy these new commits, just type:</p><pre id="247a">git push live master</pre><figure id="23c9"><div><div><img src="https://cdn-images-1.medium.com/freeze/max/60/1*S1RgX8G7bjlM4b1QTPZSRQ.png?q=20" /><div class="readableLargeImageContainer"><img src="https://cdn-images-1.medium.com/max/1600/1*S1RgX8G7bjlM4b1QTPZSRQ.png" /></div></figure><p id="d872"><em>PS: It feels sooooooooo good if it works.</em></p><h3 id="7a97">Resource:</h3><p id="8ef3"><a href="https://stackoverflow.com/a/31590993/6666165" target="_blank">How to use git bare repo in detail</a>.</p>