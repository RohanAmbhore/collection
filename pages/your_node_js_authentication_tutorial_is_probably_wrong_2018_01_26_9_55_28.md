<a href="https://hackernoon.com/your-node-js-authentication-tutorial-is-wrong-f1a3bf831a46">https://hackernoon.com/your-node-js-authentication-tutorial-is-wrong-f1a3bf831a46</a><div id="articleHeader"><h1>Your Node.js authentication tutorial is (probably) wrong</h1></div><p id="e487"><strong>tl;dr: </strong>I went on a search of Node.js/Express.js authentication tutorials. All of them were incomplete or made a security mistake in some way that can potentially hurt new users. This post explores some common authentication pitfalls, how to avoid them, and what to do to help yourself when your tutorials don‚Äôt help you anymore. I am still searching for a robust, all-in-one solution for authentication in Node/Express that rivals Rails‚Äôs <a href="https://github.com/plataformatec/devise" target="_blank">Devise</a>.</p><blockquote id="4af9"><strong>Update (Aug 7)</strong>: RisingStack has reached out and <a href="https://github.com/RisingStack/nodehero-authentication/commit/9d69ea70b68c4971466c64382e5f038e3eda8d8a" target="_blank">no longer stores passwords in plaintext</a> in their tutorial, opting to move to bcrypt in their example codes and tutorials.<br /><strong>Update (Aug 8):</strong> Editing title to <em>Your Node.js authentication tutorial is (probably) wrong</em>, as this post has improved some of these tutorials.<br /><strong>Update (Aug 10): </strong><a href="https://twitter.com/dmcghan" target="_blank"><em>Dan McGhan</em></a><em> found that one of the tutorials has addressed an issue that I had somehow missed in this documentation. I‚Äôve omitted the graf for now, as Medium doesn‚Äôt allow for strikethrough. After all, I make mistakes, too. üòä An addendum is placed at the end of this article.</em></blockquote><p id="7345">In my spare time, I‚Äôve been digging through various Node.js tutorials, as it seems that every Node.js developer with a blog has released their own tutorial on how to do things <em>the right way</em>, or, more accurately, <em>the way they do them</em>. Thousands of front-end developers being thrown into the server-side JS maelstrom are trying to piece together actionable knowledge from these tutorials, either by cargo-cult-copypasta or gratuitous use of <em>npm install </em>as they scramble frantically to meet the deadlines set for them by outsourcing managers or ad agency creative directors.</p><p id="2b07">One of the more questionable things in Node.js development is that authentication is largely left as an exercise to the individual developer<em>. </em>The <em>de facto </em>authentication solution in the Express.js world is <a href="http://passportjs.org/" target="_blank">Passport</a>, which offers a host of <em>strategies</em> for authentication. If you want a robust solution similar to <a href="https://github.com/plataformatec/devise" target="_blank">Plataformatec‚Äôs Devise</a> for Ruby on Rails, you‚Äôll likely be pointed to <a href="https://auth0.com/" target="_blank">Auth0</a>, a startup who has made authentication as a service.</p><p id="2674">Compared to Devise, Passport is simply authentication middleware, and does not handle any of the other parts of authentication for you: that means the Node.js developer is likely to roll their own API token mechanisms, password reset token mechanisms, user authentication routes and endpoints, and views in whatever templating language is the rage today. Because of this, there are a lot of tutorials that specialize in setting up Passport for your Express.js application, and nearly all of them are wrong in some way or another, and none properly implement the full stack necessary for a working web application.</p><blockquote id="b723"><strong>Note</strong>: I‚Äôm not attempting to harass the developers of these tutorials specifically, but rather I am using their authentication mistakes to show security issues inherent in rolling your own authentication systems. If you are a tutorial writer, feel free to reach out to me once you‚Äôve updated your tutorial. Let‚Äôs make Node/Express a safer ecosystem for new developers.</blockquote><h3 id="2afb">Mistake one: credential storage</h3><p id="1cb4">Let‚Äôs start with credential storage. Storing and recalling credentials is pretty standard fare for identity management, and the traditional way to do this is in your own database or application. Passport, being middleware that simply says ‚Äúthis user is cool‚Äù or ‚Äúthis user is not cool‚Äù, requires the <a href="https://github.com/jaredhanson/passport-local" target="_blank">passport-local</a> module for handling password storage in your own database, written by the same developer as Passport.js itself.</p><p id="0582">Before we go down this tutorial rabbit hole, let‚Äôs remind ourselves of a <a href="https://www.owasp.org/index.php/Password_Storage_Cheat_Sheet" target="_blank">great cheat sheet for password storage</a> by OWASP, which boils down to ‚Äústore high-entropy passwords with unique salts and one-way adaptive cost functions‚Äù. Or, really, Coda Hale‚Äôs <a href="https://codahale.com/how-to-safely-store-a-password/" target="_blank">bcrypt meme</a>, even though <a href="https://security.stackexchange.com/a/6415" target="_blank">there‚Äôs some contention</a>.</p><blockquote id="90d1"><strong>Note for experienced developers:</strong> If you <em>really</em> want to work with state of the art credential storage, <a href="https://github.com/P-H-C/phc-winner-argon2" target="_blank"><em>Argon2</em></a>is the winner of the Password Hashing Competition and now has <a href="https://github.com/emilbayes/secure-password" target="_blank">some easy support in Node.js</a>. Unfortunately, documentation for the implementation of Argon2 for novice users in the Node.js ecosystem is still lacking, and given that this is targeted toward people reading tutorials, sticking with bcrypt for the next few months seemed an OK tradeoff.</blockquote><p id="41a4">As a new Express.js and Passport user, my first place to look will be the example code for <em>passport-local</em> itself, which <a href="https://github.com/passport/express-4.x-local-example" target="_blank">thankfully gives me a sample Express.js 4.0 application</a> I can clone and extend. However, if I just copypasta this, I‚Äôm not left with too much, as there‚Äôs no database support in the example and it assumes I‚Äôm just using some set accounts.</p><p id="a4a8">That‚Äôs OK, though, right? <em>It‚Äôs just an Intranet application</em>, the dev says, <em>and I have four other projects assigned to me due next week</em>. Of course, the passwords for the example aren‚Äôt hashed in any way, <a href="https://github.com/passport/express-4.x-local-example/blob/master/db/users.js" target="_blank">and stored in plaintext right alongside the validation logic in this example</a>. Credential storage isn‚Äôt even considered in this one.</p><p id="7a86">Let‚Äôs google for another tutorial using <em>passport-local</em>. I find<a href="https://blog.risingstack.com/node-hero-node-js-authentication-passport-js/" target="_blank"> this quick tutorial from RisingStack in a series</a> called ‚ÄúNode Hero‚Äù, but that doesn‚Äôt help me, either. They, too, <a href="https://github.com/RisingStack/nodehero-authentication" target="_blank">gave me a sample application on GitHub</a>, but it had <a href="https://github.com/RisingStack/nodehero-authentication/blob/7f808f5c8ea756155099b7b4a88390c356cf31be/app/authentication/init.js#L8" target="_blank">the same problems as the official one</a>. <strong>(<em>Ed. 8/7/17: </em>RisingStack is</strong><a href="https://github.com/RisingStack/nodehero-authentication/commit/9d69ea70b68c4971466c64382e5f038e3eda8d8a" target="_blank"><strong>now using bcrypt</strong></a><strong> in their tutorial application.)</strong></p><p id="87c8">You could accuse me of cherry-picking tutorials, and you‚Äôd be right, if cherry picking means selecting from the first page of Google results. Let‚Äôs choose the <a href="https://code.tutsplus.com/tutorials/authenticating-nodejs-applications-with-passport--cms-21619" target="_blank">higher-ranked-in-results <em>passport-local</em> tutorial from TutsPlus</a>. This one is better, in that <a href="https://github.com/tutsplus/passport-mongo/blob/master/passport/login.js" target="_blank">it uses brypt with a cost factor of 10 for password hashing</a>. The top result on Google, <a href="https://scotch.io/tutorials/easy-node-authentication-setup-and-local" target="_blank">the tutorial from scotch.io</a>, also uses <a href="https://github.com/scotch-io/easy-node-authentication/blob/local/app/models/user.js#L37" target="_blank">bcrypt with a lesser cost factor of 8</a>. Both of these are small, but 8 is really small. Most <em>bcrypt</em> libraries these days use 12. <a href="https://www.usenix.org/legacy/publications/library/proceedings/usenix99/provos/provos_html/node6.html" target="_blank">The cost factor of 8 was for administrator accounts <em>eighteen years ago</em></a>when the original bcrypt paper was released.</p><p id="df3b">Password storage aside, neither of these tutorials implement password reset functionality, which is left as an exercise to the developer and comes with its own pitfalls.</p><h3 id="17ff">Mistake two: password¬†reset</h3><p id="88ac">A sister security issue to password storage is that of password reset, and none of the top basic tutorials explain how to do this at all with Passport. You‚Äôll have to follow another.</p><p id="b01d">There are a thousand ways to fuck this up. The most common ways I have witnessed that people get password reset wrong are:</p><ol><li id="d12b"><strong>Predictable tokens. </strong>Tokens that are based upon the current time are a good example. Tokens made by bad pseudorandom number generators are less obvious.</li><li id="2f40"><strong>Bad storage. </strong>Storing unencrypted password reset tokens in your DB means that if the DB is compromised, those tokens are effectively plaintext passwords. Generating a long token with a cryptographically secure random number generator stops remote brute force attacks on reset tokens, but it doesn‚Äôt stop local attacks. Reset tokens are credentials and should be treated as such.</li><li id="f6a1"><strong>No token expiry. </strong>Not expiring your tokens gives attackers more time to exploit the reset window.</li><li id="655b"><strong>No secondary data verification.</strong> Security questions are the <em>de facto</em> data verification for a reset. Of course, then the developer has to choose <em>good security questions</em>. <a href="https://www.kaspersky.com/blog/security-questions-are-insecure/13004/" target="_blank">Security questions have their own problems</a>. While this may seem like security overkill, the email address is something you have, not something you know, and conflates the authentication factors. Your email address becomes the key to every account that just sends a reset token to email.</li></ol><p id="fa78">If you‚Äôre new all of this, try OWASP‚Äôs <a href="https://www.owasp.org/index.php/Forgot_Password_Cheat_Sheet" target="_blank">Password Reset Cheat Sheet</a>. Let‚Äôs get back to what the Node world has to offer for us on this.</p><p id="338c">We‚Äôll divert to <em>npm </em>for a second and <a href="https://www.npmjs.com/search?q=password%20reset&page=1&ranking=popularity" target="_blank">look for password reset</a>, to see if anyone‚Äôs made this. There‚Äôs a five-year-old package from the (generally awesome) substack. On the Node.js timeline this module is jurassic, and if I wanted to nitpick, <a href="https://security.stackexchange.com/questions/84906/predicting-math-random-numbers" target="_blank">Math.random() is predictable in V8</a>, so <a href="https://github.com/substack/node-password-reset/blob/master/index.js#L73" target="_blank">it shouldn‚Äôt be used for token generation</a>. Also, it doesn‚Äôt use Passport, so we‚Äôll move on.</p><p id="c14d">Stack Overflow isn‚Äôt of too much help, as developer relations from a company called Stormpath loved plugging their IaaS startup on every imaginable post regarding this. <a href="https://docs.stormpath.com/client-api/product-guide/latest/password_reset.html" target="_blank">Their documentation also popped up everywhere</a> and they have <a href="https://stormpath.com/blog/the-pain-of-password-reset" target="_blank">a blogvertisement on password reset, as well</a>. However, all of this is for naught as Stormpath is defunct, <a href="https://stormpath.com/" target="_blank">and it shuts down entirely</a> August 17, 2017.</p><p id="6732">Alright, back to Google, for the only tutorial that seems to exist out there. We‚Äôll take <a href="http://sahatyalkabov.com/how-to-implement-password-reset-in-nodejs/" target="_blank">the first result</a> for the Google search <em>express passport password reset. </em>Here is our old friend <em>bcrypt</em> again, with an even smaller cost factor of 5 used in the text, which is <em>far</em> too small of a cost factor for modern use.</p><p id="115d">However, this tutorial is pretty solid compared to others in that it uses <em>crypto.randomBytes</em> to generate truly random tokens, and expires them if they aren‚Äôt used. However #2 and #4 of the practices above aren‚Äôt honored by this comprehensive tutorial, and thus the password tokens themselves are vulnerable to authentication mistake number one, credential storage.</p><p id="b639">Thankfully, this is of limited use thanks to the reset expiry. However, these tokens are especially fun if an attacker has read access to the user objects in the DB via BSON injection or can access Mongo freely due to misconfiguration. The attacker can just issue password resets for every user, read the unencrypted tokens from the DB, and set their own passwords for user accounts instead of having to go through the costly process of dictionary attacks on bcrypt hashes with a GPU rig.</p><h3 id="0560">Mistake three: API¬†tokens</h3><p id="0574">API tokens are credentials. They are just as sensitive as passwords or reset tokens. Most every developer knows this and tries to hold their AWS keys, Twitter secrets, etc. close to their chest, however this doesn‚Äôt seem to transfer into the code being authored.</p><p id="0b98">Let‚Äôs use <a href="https://jwt.io/" target="_blank">JSON Web Tokens</a> for API credentials. Having a stateless, blacklistable, claimable token is better than the old API key/secret pattern that has been used for the better part of a decade. Perhaps our junior Node.js dev has heard of JWT somewhere before, or saw <em>passport-jwt</em> and decided to implement the JWT strategy. In any case, JWT is where everyone seems to be moving in the Node.js sphere of influence. (The venerable <a href="https://news.ycombinator.com/item?id=13866883" target="_blank">Thomas Ptacek will argue that JWT is bad</a> but I‚Äôm afraid that ship has sailed here.)</p><p id="880e">We‚Äôll search for <em>express js jwt</em> on Google, and then find <a href="https://medium.com/u/8d4c0a555bc3" target="_blank">Soni Pandey</a>‚Äôs tutorial <a href="https://medium.com/@pandeysoni/user-authentication-using-jwt-json-web-token-in-node-js-using-express-framework-543151a38ea1" target="_blank"><em>User Authentication using JWT (JSON Web Token) in Node.js</em></a>which is the first tutorial result. Unfortunately, this doesn‚Äôt actually help us at all, since it doesn‚Äôt use Passport, but while we‚Äôre here we‚Äôll quickly note the mistakes in credential storage:</p><ol><li id="692f">We‚Äôll store the <a href="https://github.com/pandeysoni/User-Authentication-using-JWT-JSON-Web-Token-in-Node.js-Express/blob/master/server/config/config.js#L13" target="_blank">JWT key in plaintext in the repository</a>.</li><li id="bebb">We‚Äôll <a href="https://github.com/pandeysoni/User-Authentication-using-JWT-JSON-Web-Token-in-Node.js-Express/blob/master/server/config/common.js#L54" target="_blank">use a symmetric cipher to store passwords</a>. This means that I can get the encryption key and decrypt all of the passwords in event of a breach. The encryption key is shared with the JWT secret.</li><li id="c59e">We‚Äôll use AES-256-CTR for password storage. We shouldn‚Äôt be using AES to start, and this mode of operation doesn‚Äôt help. I am not sure why this mode specifically was chosen, but <a href="https://crypto.stackexchange.com/a/33861" target="_blank">the choice alone leaves the ciphertext malleable</a>.</li></ol><p id="d8c2">Welp. Let‚Äôs back out to Google and we find the next tutorial. Scotch, which did an OK job with password storage in their passport-local tutorial, <a href="https://github.com/scotch-io/node-token-authentication/blob/master/app/models/user.js#L7" target="_blank">just ignores what they told you before and stores the passwords in plaintext</a> for this example.</p><p id="ee84">Uh, we‚Äôll give that a pass for brevity, but it doesn‚Äôt help the copypasta crew. That‚Äôs because more interestingly, this tutorial <a href="https://github.com/scotch-io/node-token-authentication/blob/master/server.js#L81" target="_blank">also serializes the mongoose User object into the JWT</a>.</p><p id="2491">Let‚Äôs clone the Scotch tutorial repository, follow the instructions, and run it. After a <em>DeprecationWarning </em>or three from Mongoose, we can hit <a href="http://localhost:8080/setup" target="_blank"><em>http://localhost:8080/setup</em></a>to create the user, then get a token by posting to /api/authenticate with the default credentials of ‚ÄúNick Cerminara‚Äù and ‚Äúpassword‚Äù. A token is returned, as displayed from Postman.</p><figure id="5fe8"><div><div><img src="https://cdn-images-1.medium.com/freeze/max/60/1*wvb2F4-Rx4I1ji2EJIyXZg.png?q=20" /><div class="readableLargeImageContainer"><img src="https://cdn-images-1.medium.com/max/1600/1*wvb2F4-Rx4I1ji2EJIyXZg.png" /></div><figcaption>A JWT token returned from the Scotch tutorial.</figcaption></figure><p id="038d">Note that JSON Web Tokens are signed, but not encrypted. That means that big blob between the two periods is a Base64-encoded object. Quickly decoding it, we get something interesting.</p><figure id="fee7"><div><div><img src="https://cdn-images-1.medium.com/freeze/max/60/1*5KcDyNtIfWXVe9uVUD0A_g.png?q=20" /><div class="readableLargeImageContainer"><img src="https://cdn-images-1.medium.com/max/1600/1*5KcDyNtIfWXVe9uVUD0A_g.png" /></div><figcaption>I love my passwords in plaintext in¬†tokens.</figcaption></figure><p id="4275">Now, anyone that has <em>even an expired token</em> has your password, as well as whatever else is stored in the Mongoose model. Given that this one came over HTTP, I could have sniffed it off of the wire.</p><p id="e560">What about the next tutorial? The next tutorial, <a href="https://jonathanmh.com/express-passport-json-web-token-jwt-authentication-beginners/" target="_blank"><em>Express, Passport and JSON Web Token (jwt) Authentication for Beginners</em></a><em>, </em>contains the same information disclosure vulnerability<em>. </em>The next tutorial from a startup called <a href="http://blog.slatepeak.com/creating-a-simple-node-express-api-authentication-system-with-passport-and-jwt/" target="_blank">SlatePeak does the same serialization</a>. At this point, I gave up looking.</p><h3 id="d577">Mistake four: rate¬†limiting</h3><p id="ee23">As I alluded to above, I did not find a mention of rate limiting or account locking in any of these authentication tutorials.</p><p id="2017">Without rate limiting, an adversary can perform online dictionary attacks in which a tool like <a href="https://portswigger.net/burp/help/intruder_using.html" target="_blank">Burp Intruder</a> is run in hopes of gaining access to an account with a weak password. Account lockout also helps with this problem by requiring extended login information from a user the next time they log in.</p><p id="f8e4">Remember, rate limiting also helps availability. <em>bcrypt</em> is a CPU-intensive function, and without rate limiting functions using bcrypt become an application-level denial of service vector, especially at high work factors. Multiple requests for user registration or login password checking are an easy way to turn a lightweight HTTP request into costly time for your server.</p><p id="8de9">While I do not have a tutorial I can point to for these, there are tons of rate limiting middlewares for Express, such as <a href="https://github.com/nfriedly/express-rate-limit" target="_blank">express-rate-limit</a>, <a href="https://www.npmjs.com/package/express-limiter" target="_blank">express-limiter</a>, and <a href="https://github.com/AdamPflug/express-brute" target="_blank">express-brute</a>. I cannot speak to the security of these modules and have not even looked at them; generally I <a href="https://expressjs.com/en/advanced/best-practice-performance.html#use-a-reverse-proxy" target="_blank">recommend running a reverse proxy in production</a> and allowing <a href="https://www.nginx.com/blog/rate-limiting-nginx/" target="_blank">rate limiting to requests to be handled by nginx</a> or whatever your load balancer is.</p><h3 id="f0ef">Authentication is¬†hard.</h3><p id="d86a">I‚Äôm sure the tutorial developers will defend themselves with ‚ÄúThis is just meant to explain the basics! Surely nobody will do this in production!‚Äù However, I cannot emphasize enough <em>just how false this is</em>. This is <em>especially</em> true when code is put out there in your tutorials. People will take your word for it‚Ää‚Äî‚Ääafter all, you <em>do</em> have more expertise than they do.</p><p id="177b"><strong>If you‚Äôre a beginner, don‚Äôt trust your tutorials.</strong> Copypasta from tutorials <em>will</em> likely get you, your company, and your clients in authentication trouble in the Node.js world. If you really need strong, production-ready, all-in-one authentication libraries, go back to something that holds your hand better, has better stability, and is more proven, like Rails/Devise.</p><p id="7055">The Node.js ecosystem, while accessible, still has a lot of sharp edges for JavaScript-based developers needing to write production web applications in a hurry. If you have a front-end background and don‚Äôt know other programming languages, I personally believe it is easier to pick up Ruby and stand on the shoulders of giants than it is to quickly learn how not to shoot yourself in the foot when writing these types of things from scratch.</p><p id="2398">If you‚Äôre a tutorial writer, <em>please</em> update your tutorials, <em>especially </em>the boilerplate code. This code will become copypasta into others‚Äô production web applications.</p><p id="8f2e">If you are a die-hard Node.js developer, hopefully you‚Äôve learned a few things not to do in your authentication system you‚Äôre rolling with Passport. You will likely get something wrong. I haven‚Äôt gotten close to covering all of the ways to get it wrong in this one post. It shouldn‚Äôt be your job to roll your own auth for your Express application. There should be something better.</p><p id="634f">If you‚Äôre interested in better securing the Node ecosystem, please DM me <a href="https://twitter.com/_micaksica" target="_blank">@_micaksica</a> on Twitter.</p><blockquote id="9540">This post was brought to you by espresso because I‚Äôm out of sake.</blockquote><h4 id="18c2">Addendum (last updated August 10,¬†2017)</h4><p id="1bbf">This post started out of frustration from the problems I had been seeing, and has somehow taken on a life of its own. It has received more responses, more feedback, and caused more controversy than I had expected it to. Clearly this has been a point of frustration for other developers.</p><p id="aabc">If you find errors in this post, please message me and we‚Äôll work to fix them. What we don‚Äôt need is another misguided post. That‚Äôs the opposite of what we need.</p><p id="da6c">However, I implore you: let‚Äôs not just work on this post. Let‚Äôs make the ecosystem better in the future. If you find errors or have other practices, things you‚Äôve learned in production, or simply improvements, feel free to DM me. <strong>It seems that the next best step for us is to write a living document</strong> containing ‚Äúcheat sheet‚Äù style best practices around authentication with Node/Express as a patch until there are proven, robust solutions.</p><p id="1022">To that end, I‚Äôve started <a href="https://gitlab.com/micaksica/nodeauth-best-practices" target="_blank">a repository on GitLab</a>. Feel free to file issues, your recommendations, or make some pull requests to get us started. I‚Äôll work on it as soon as I get a chance this upcoming weekend.</p>